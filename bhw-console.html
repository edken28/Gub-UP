function fetchGlobalMedicineStock() {
    onSnapshot(collection(db, "medicine_inventory"), (snapshot) => {
        let totalItems = 0;
        let totalHealthPoints = 0;
        let globalQuantity = 0;

        snapshot.forEach(doc => {
            const qty = parseInt(doc.data().quantity || 0);
            globalQuantity += qty;
            totalItems++;

            // Statistical Scoring per item
            if (qty >= 500) totalHealthPoints += 100;      // Good
            else if (qty >= 300) totalHealthPoints += 75;  // Medium
            else if (qty >= 100) totalHealthPoints += 50;  // Low
            else totalHealthPoints += 10;                  // Critical
        });

        // The new percentage is the average health of all medicine types
        const stockHealthPercentage = totalItems > 0 
            ? Math.round(totalHealthPoints / totalItems) 
            : 0;

        document.getElementById('avg-medicine-stock').innerText = `${stockHealthPercentage}%`;
        
        const status = document.getElementById('stock-status-text');
        
        // Status label based on the weakest link
        if (stockHealthPercentage >= 90) {
            status.innerText = "Good / Sufficient";
            status.className = "text-xs mt-1 font-bold text-emerald-500";
        } else if (stockHealthPercentage >= 60) {
            status.innerText = "Medium Level";
            status.className = "text-xs mt-1 font-bold text-blue-500";
        } else {
            status.innerText = "Critical Items Detected";
            status.className = "text-xs mt-1 font-bold text-red-500 animate-pulse";
        }
    });
}
