<script type="module">
    // 1. Added 'serverTimestamp' to imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, collection, onSnapshot, doc, addDoc, 
        updateDoc, deleteDoc, getDoc, query, orderBy, 
        serverTimestamp // <--- Added this
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB2OEoFPk-eNzqSwK-JFXBrmssU01NeVkE",
        authDomain: "gub-up.firebaseapp.com",
        projectId: "gub-up",
        storageBucket: "gub-up.firebasestorage.app",
        messagingSenderId: "75119179497",
        appId: "1:75119179497:web:2e0195a3dfd4fb03e5a278"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let allCases = [];

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().role === "rhu") {
                document.getElementById('user-name-display').innerText = userDoc.data().name;
                document.body.classList.add('auth-ready');
                AOS.init({ duration: 600, once: true });
                initData();
            } else { window.location.href = "dashboard.html"; }
        } else { window.location.href = "login.html"; }
    });

    function initData() {
        // Updated to order by most recent case first for the RHU console
        const q = query(collection(db, "disease_cases"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            allCases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable(allCases);
        });
    }

    // SEARCH FUNCTIONALITY
    document.getElementById('disease-search').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allCases.filter(item => 
            item.name.toLowerCase().includes(term) || 
            item.barangay.toLowerCase().includes(term)
        );
        renderTable(filtered);
    });

    function renderTable(data) {
        const tbody = document.getElementById('disease-table-body');
        tbody.innerHTML = "";
        if(data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="py-20 text-center text-slate-400 font-medium">No cases found...</td></tr>`;
            return;
        }
        data.forEach(item => {
            let sevClass = item.severity === "High" ? "severity-high" : (item.severity === "Medium" ? "severity-medium" : "severity-low");
            tbody.innerHTML += `
                <tr class="hover:bg-slate-50 transition-all group">
                    <td class="px-10 py-7">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-red-50 text-rhu-red rounded-lg flex items-center justify-center"><i data-lucide="virus" class="w-4 h-4"></i></div>
                            <span class="font-bold text-navy text-lg">${item.name}</span>
                        </div>
                    </td>
                    <td class="px-8 py-7 text-slate-500 font-bold uppercase text-xs">${item.barangay}</td>
                    <td class="px-8 py-7 text-center font-black text-navy text-xl">${item.count}</td>
                    <td class="px-8 py-7"><span class="px-4 py-1.5 rounded-xl text-[10px] font-black uppercase ${sevClass}">${item.severity}</span></td>
                    <td class="px-10 py-7 text-right">
                        <div class="flex justify-end gap-3">
                            <button onclick="editEntry('${item.id}', '${item.name}', '${item.barangay}', ${item.count}, '${item.severity}')" class="p-3 bg-white border border-slate-100 text-slate-400 rounded-xl hover:bg-navy hover:text-white transition-all shadow-sm">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteEntry('${item.id}')" class="p-3 bg-white border border-slate-100 text-slate-400 rounded-xl hover:bg-red-600 hover:text-white transition-all shadow-sm">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
        });
        lucide.createIcons();
    }

    const modal = document.getElementById('case-modal');
    const caseForm = document.getElementById('case-form');
    const saveBtn = document.getElementById('save-btn');
    const saveBtnText = document.getElementById('save-btn-text');

    window.openAddModal = () => {
        caseForm.reset();
        document.getElementById('entry-id').value = "";
        document.getElementById('modal-title').innerText = "Add New Entry";
        modal.classList.remove('hidden');
        lucide.createIcons();
    };

    window.closeModal = () => {
        modal.classList.add('hidden');
    };

    window.editEntry = (id, name, barangay, count, severity) => {
        document.getElementById('entry-id').value = id;
        document.getElementById('case-name').value = name;
        document.getElementById('case-barangay').value = barangay;
        document.getElementById('case-count').value = count;
        document.getElementById('case-severity').value = severity;
        document.getElementById('modal-title').innerText = "Edit Entry";
        modal.classList.remove('hidden');
        lucide.createIcons();
    };

    window.deleteEntry = async (id) => {
        if(confirm("Confirm deletion of this disease case?")) {
            await deleteDoc(doc(db, "disease_cases", id));
        }
    };

    caseForm.onsubmit = async (e) => {
        e.preventDefault();
        saveBtn.disabled = true;
        saveBtn.style.opacity = "0.7";
        saveBtnText.innerText = "Saving...";

        const id = document.getElementById('entry-id').value;
        const now = new Date();
        
        // 2. Data object now includes Time-Tracking fields
        const data = {
            name: document.getElementById('case-name').value,
            barangay: document.getElementById('case-barangay').value,
            count: parseInt(document.getElementById('case-count').value),
            severity: document.getElementById('case-severity').value,
            updatedAt: serverTimestamp(), // Tracks last edit
            reportMonth: now.getMonth() + 1, // 1-12
            reportYear: now.getFullYear()    // e.g. 2026
        };

        try {
            if(id) {
                await updateDoc(doc(db, "disease_cases", id), data);
            } else {
                // For new cases, we set the initial creation time
                data.createdAt = serverTimestamp();
                await addDoc(collection(db, "disease_cases"), data);
            }
            closeModal();
        } catch (error) {
            alert("Error saving: " + error.message);
        } finally {
            saveBtn.disabled = false;
            saveBtn.style.opacity = "1";
            saveBtnText.innerText = "Confirm & Save";
        }
    };

    document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => window.location.href = "login.html");
</script>
