<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disease Inventory | GUB-UP RHU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-active { background-color: #eef2ff; color: #4338ca; }
        .status-monitoring { background-color: #f5f3ff; color: #7c3aed; }
        .status-resolved { background-color: #f0fdf4; color: #166534; }
        .severity-high { background-color: #fef2f2; color: #991b1b; }
        .severity-moderate { background-color: #fffbeb; color: #92400e; }
        .severity-low { background-color: #f0fdf4; color: #166534; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <main class="p-4 md:p-10 max-w-7xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Filter by Barangay</label>
                <select id="brgy-filter" class="w-full p-3 bg-white border border-slate-200 rounded-xl shadow-sm outline-none focus:ring-2 focus:ring-blue-500/20 transition-all">
                    <option value="All">All Barangays</option>
                    <option value="Poblacion">Poblacion</option>
                    <option value="Cogon">Cogon</option>
                    <option value="Bentuco">Bentuco</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Filter by Disease</label>
                <select id="disease-filter" class="w-full p-3 bg-white border border-slate-200 rounded-xl shadow-sm outline-none focus:ring-2 focus:ring-blue-500/20 transition-all">
                    <option value="All">All Diseases</option>
                    <option value="Dengue">Dengue</option>
                    <option value="Hypertension">Hypertension</option>
                    <option value="COVID-19">COVID-19</option>
                </select>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b border-slate-100 text-slate-500 text-sm font-semibold">
                            <th class="px-6 py-5">Report ID</th>
                            <th class="px-6 py-5">Disease</th>
                            <th class="px-6 py-5">Barangay</th>
                            <th class="px-6 py-5">Cases</th>
                            <th class="px-6 py-5">Severity</th>
                            <th class="px-6 py-5">Date</th>
                            <th class="px-6 py-5">Status</th>
                            <th class="px-6 py-5 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="divide-y divide-slate-50">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="edit-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">Adjust Disease Record</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
            </div>

            <form id="update-form" class="space-y-5">
                <input type="hidden" id="edit-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Disease</label>
                        <p id="modal-disease-name" class="font-bold text-slate-700">--</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Barangay</label>
                        <p id="modal-brgy-name" class="font-bold text-slate-700">--</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Update Case Count</label>
                    <input type="number" id="edit-cases" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-lg focus:ring-2 focus:ring-blue-500/20 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Severity</label>
                        <select id="edit-severity" class="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none">
                            <option value="High">High</option>
                            <option value="Moderate">Moderate</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
                        <select id="edit-status" class="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none">
                            <option value="Active">Active</option>
                            <option value="Monitoring">Monitoring</option>
                            <option value="Resolved">Resolved</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all mt-4">
                    Save Changes
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { /* Your Config */ };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Fetching and Rendering
        const tableBody = document.getElementById('inventory-table-body');

        onSnapshot(query(collection(db, "disease_reports"), orderBy("date", "desc")), (snapshot) => {
            tableBody.innerHTML = "";
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;

                const severityClass = `severity-${data.severity.toLowerCase()}`;
                const statusClass = `status-${data.status.toLowerCase()}`;

                tableBody.innerHTML += `
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="px-6 py-5 text-blue-600 font-bold text-sm">RPT-${id.substring(0,5).toUpperCase()}</td>
                        <td class="px-6 py-5">
                            <div class="font-bold text-slate-800">${data.disease}</div>
                            <div class="text-[10px] text-slate-400 font-medium">by ${data.officer || 'RHU Admin'}</div>
                        </td>
                        <td class="px-6 py-5 text-slate-500 font-medium text-sm flex items-center gap-1">
                            <i data-lucide="map-pin" class="w-3 h-3 text-slate-300"></i> ${data.barangay}
                        </td>
                        <td class="px-6 py-5 font-black text-slate-800 text-lg">${data.cases}</td>
                        <td class="px-6 py-5">
                            <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${severityClass}">${data.severity}</span>
                        </td>
                        <td class="px-6 py-5 text-slate-400 text-xs font-medium">${data.date}</td>
                        <td class="px-6 py-5">
                            <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${statusClass}">${data.status}</span>
                        </td>
                        <td class="px-6 py-5 text-right">
                            <button onclick="openEditModal('${id}', '${data.disease}', '${data.barangay}', ${data.cases}, '${data.severity}', '${data.status}')" 
                                    class="p-2 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-blue-600 transition-all">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            lucide.createIcons();
        });

        // Edit Logic
        window.openEditModal = (id, disease, brgy, cases, severity, status) => {
            document.getElementById('edit-id').value = id;
            document.getElementById('modal-disease-name').innerText = disease;
            document.getElementById('modal-brgy-name').innerText = brgy;
            document.getElementById('edit-cases').value = cases;
            document.getElementById('edit-severity').value = severity;
            document.getElementById('edit-status').value = status;
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('edit-modal').classList.add('hidden');

        document.getElementById('update-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            await updateDoc(doc(db, "disease_reports", id), {
                cases: parseInt(document.getElementById('edit-cases').value),
                severity: document.getElementById('edit-severity').value,
                status: document.getElementById('edit-status').value
            });
            closeModal();
        });
    </script>
</body>
</html>
