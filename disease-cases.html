<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barangay Disease Control | GUB-UP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .bg-rhu { background-color: #be123c; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-900">Barangay Disease Manager</h1>
                <p class="text-rose-600 font-bold text-sm">RHU Official Management Console</p>
            </div>
            <div class="flex gap-2 bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                <i data-lucide="map-pin" class="text-rose-500"></i>
                <select id="barangay-selector" class="font-bold text-slate-700 outline-none bg-transparent">
                    <option value="Poblacion">Poblacion</option>
                    <option value="Pinontingan">Pinontingan</option>
                    <option value="Benguet">Benguet</option>
                    </select>
            </div>
        </div>

        <div id="disease-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
    </main>

    <div id="edit-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-md p-8 shadow-2xl">
            <h3 id="modal-title" class="text-2xl font-black text-slate-900 mb-2">Adjust Case Load</h3>
            <p id="modal-brgy" class="text-rose-500 font-bold text-xs uppercase mb-6 tracking-widest"></p>
            
            <form id="update-form" class="space-y-6">
                <input type="hidden" id="target-disease">
                
                <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 text-center">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Total Active Cases</label>
                    <div class="flex items-center justify-center gap-6">
                        <button type="button" onclick="changeQty(-1)" class="w-12 h-12 bg-white rounded-2xl shadow-sm border border-slate-200 flex items-center justify-center hover:bg-rose-50 text-rose-600 font-bold">-</button>
                        <input type="number" id="case-count" class="w-20 text-3xl font-black text-center bg-transparent outline-none text-slate-900" value="0">
                        <button type="button" onclick="changeQty(1)" class="w-12 h-12 bg-white rounded-2xl shadow-sm border border-slate-200 flex items-center justify-center hover:bg-emerald-50 text-emerald-600 font-bold">+</button>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 py-4 font-bold text-slate-400 hover:bg-slate-50 rounded-2xl transition-all">Cancel</button>
                    <button type="submit" class="flex-1 py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg hover:bg-slate-800 transition-all">Update Registry</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { /* ... your config ... */ };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const barangaySelect = document.getElementById('barangay-selector');
        const grid = document.getElementById('disease-grid');

        // Watch for Barangay Changes
        barangaySelect.addEventListener('change', loadBarangayData);

        function loadBarangayData() {
            const brgy = barangaySelect.value;
            // Listening to a document named after the barangay in a "disease_stats" collection
            onSnapshot(doc(db, "disease_stats", brgy), (snapshot) => {
                grid.innerHTML = "";
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    Object.entries(data).forEach(([disease, count]) => {
                        createCard(disease, count);
                    });
                } else {
                    // Default view if no data exists yet
                    ["Dengue", "COVID-19", "Measles", "Flu"].forEach(d => createCard(d, 0));
                }
                lucide.createIcons();
            });
        }

        function createCard(name, count) {
            const card = document.createElement('div');
            card.className = "bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 hover:shadow-xl hover:shadow-rose-500/5 transition-all cursor-pointer";
            card.onclick = () => openModal(name, count);
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="p-4 bg-rose-50 text-rose-600 rounded-2xl">
                        <i data-lucide="activity"></i>
                    </div>
                    <span class="text-4xl font-black text-slate-900">${count}</span>
                </div>
                <h3 class="text-xl font-black text-slate-800 capitalize">${name}</h3>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Active in ${barangaySelect.value}</p>
            `;
            grid.appendChild(card);
        }

        // Modal Logic
        window.openModal = (name, count) => {
            document.getElementById('target-disease').value = name;
            document.getElementById('case-count').value = count;
            document.getElementById('modal-title').innerText = `Adjust ${name}`;
            document.getElementById('modal-brgy').innerText = `Brgy. ${barangaySelect.value}`;
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('edit-modal').classList.add('hidden');

        window.changeQty = (val) => {
            const input = document.getElementById('case-count');
            let res = parseInt(input.value) + val;
            input.value = res < 0 ? 0 : res;
        };

        document.getElementById('update-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const brgy = barangaySelect.value;
            const disease = document.getElementById('target-disease').value;
            const newCount = parseInt(document.getElementById('case-count').value);

            const docRef = doc(db, "disease_stats", brgy);
            const snap = await getDoc(docRef);
            
            let updateData = snap.exists() ? snap.data() : {};
            updateData[disease] = newCount;

            await setDoc(docRef, updateData);
            closeModal();
        });

        // Init
        loadBarangayData();
        lucide.createIcons();
    </script>
</body>
</html>
