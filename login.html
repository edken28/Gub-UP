<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    // ADDED: Firestore imports
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB2OEoFPk-eNzqSwK-JFXBrmssU01NeVkE",
        authDomain: "gub-up.firebaseapp.com",
        projectId: "gub-up",
        storageBucket: "gub-up.firebasestorage.app",
        messagingSenderId: "75119179497",
        appId: "1:75119179497:web:2e0195a3dfd4fb03e5a278",
        measurementId: "G-9MGFP3RC88"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    // ADDED: Initialize Firestore
    const db = getFirestore(app);

    const loginForm = document.getElementById('loginForm');

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            // 1. Sign in the user
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            // 2. Fetch the user's role from Firestore
            const userDoc = await getDoc(doc(db, "users", user.uid));
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                
                // 3. Conditional Redirect based on role
                if (userData.role === "worker") {
                    // Redirect to Worker Panel
                    window.location.href = "worker-panel.html"; 
                } else {
                    // Redirect to standard Dashboard
                    window.location.href = "dashboard.html";
                }
            } else {
                // If user authenticated but has no document, default to dashboard
                window.location.href = "dashboard.html";
            }

        } catch (error) {
            console.error("Login error:", error);
            
            if (error.code === 'auth/invalid-credential') {
                alert("Wrong email or password. Please try again.");
            } else if (error.code === 'auth/user-not-found') {
                alert("No account found with this email.");
            } else {
                alert("Error: " + error.message);
            }
        }
    });
</script>
